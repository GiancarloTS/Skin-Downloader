<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>LOL Skins Downloader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="index.css" />
    <!-- Objetos separados en archivos externos -->
    <script src="championRoles.js"></script>
    <script src="iconMap.js"></script>
    <script src="loadscreenMap.js"></script>
  </head>
  <body>
    <div class="container py-4">
      <h1 class="text-center fw-bold" style="color: #f5c518">Bienvenido a LOL Skins Downloader</h1>
      <div class="d-flex justify-content-between mb-4">
        <div>
          <button id="settingsBtn" class="btn btn-secondary me-2">⚙ Ajustes</button>
          <button id="changeDir" class="btn btn-gold px-4 py-2">Cambiar directorio de descarga</button>
        </div>
      </div>
      <!-- Modal de Ajustes -->
      <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content bg-dark-custom text-light">
            <div class="modal-header">
              <h5 class="modal-title" id="settingsModalLabel">Ajustes</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <label for="githubToken" class="form-label">Token de GitHub:</label>
              <input type="text" id="githubToken" class="form-control" placeholder="Pega aquí tu token personal" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-gold" id="saveTokenBtn">Guardar</button>
            </div>
          </div>
        </div>
      </div>
      <h2 class="text-center fw-bold" style="color: #f5c518">Campeones</h2>
      <div class="d-flex flex-column align-items-center mb-2">
        <div id="roleFilters" class="mb-2">
          <button class="btn btn-gold me-2 mb-1" data-role="all">Todos</button>
          <button class="btn btn-gold me-2 mb-1" data-role="top">Top</button>
          <button class="btn btn-gold me-2 mb-1" data-role="jg">JG</button>
          <button class="btn btn-gold me-2 mb-1" data-role="mid">Mid</button>
          <button class="btn btn-gold me-2 mb-1" data-role="adc">ADC</button>
          <button class="btn btn-gold me-2 mb-1" data-role="supp">Supp</button>
        </div>
        <input id="championSearch" type="text" class="form-control w-50" placeholder="Buscar campeón..." style="max-width: 400px" />
      </div>
      <div id="championsGrid" class="row g-4 justify-content-center"></div>
      <div id="skinsList" class="mt-4"></div>
    </div>

    <script>
      // --- Estado global ---
      let championsCache = [];
      let currentRole = "all";

      // --- Utilidades ---
      function normalizeChampionName(name) {
        return name
          .toLowerCase()
          .replace(/á/g, "a")
          .replace(/é/g, "e")
          .replace(/í/g, "i")
          .replace(/ó/g, "o")
          .replace(/ú/g, "u")
          .replace(/ñ/g, "n")
          .replace(/[^a-z0-9]/g, "");
      }

      // --- Renderizado de campeones ---
      async function loadChampions(search = "", role = "all") {
        const grid = document.getElementById("championsGrid");
        grid.innerHTML = "<p>Cargando...</p>";
        try {
          if (championsCache.length === 0) {
            championsCache = await window.skinsAPI.getChampions();
          }
          const statusData = await window.skinsAPI.getChampionStatus();
          const championRoles = window.championRoles;
          const iconMap = window.iconMap;
          const loadscreenMap = window.loadscreenMap;

          let champions = championsCache.filter((name) =>
            name.toLowerCase().includes(search.toLowerCase())
          );
          if (role !== "all") {
            champions = champions.filter((name) => {
              const roles = championRoles[name] || [];
              return roles.includes(role);
            });
          }
          grid.innerHTML = "";

          champions.forEach((name) => {
            let champKey = iconMap[name.toLowerCase()] || name;
            let loadscreenUrl = loadscreenMap[name] ||
              `https://raw.communitydragon.org/latest/game/assets/characters/${normalizeChampionName(name)}/skins/base/${normalizeChampionName(name)}loadscreen.png`;

            const col = document.createElement("div");
            col.className = "col-12 col-sm-6 col-md-4 col-lg-2 d-flex justify-content-center";
            const card = document.createElement("div");
            card.className = "champion-card card bg-dark-custom border-0 mb-2 position-relative";
            card.style.width = "180px";
            card.style.cursor = "pointer";

            // Advertencia de status
            if (statusData && statusData[name]) {
              const alertDiv = document.createElement("div");
              alertDiv.className = "alert alert-warning p-2 position-absolute top-0 end-0 m-2";
              alertDiv.style.zIndex = 10;
              let warnings = statusData[name];
              if (!Array.isArray(warnings)) warnings = [warnings];
              alertDiv.innerHTML = warnings.map(w => `<b>${w.skin}</b>: ${w.descripcion}`).join('<br><br>');
              card.appendChild(alertDiv);
            }

            const img = document.createElement("img");
            img.src = loadscreenUrl;
            img.alt = name;
            img.className = "card-img-top";
            img.onerror = function () {
              img.src = "https://static.wikia.nocookie.net/leagueoflegends/images/6/6e/Champion.png";
            };
            card.appendChild(img);

            const label = document.createElement("div");
            label.textContent = champKey;
            label.className = "champion-label card-footer text-center";
            card.appendChild(label);

            card.addEventListener("click", () => {
              window.location.href = `skins.html?champion=${encodeURIComponent(normalizeChampionName(name))}`;
            });

            col.appendChild(card);
            grid.appendChild(col);
          });
        } catch (e) {
          grid.innerHTML = "<p>Error al cargar campeones.</p>";
        }
      }

      // --- Inicialización de eventos ---
      function initEvents() {
        const searchInput = document.getElementById("championSearch");
        if (searchInput) {
          searchInput.addEventListener("input", (e) => {
            loadChampions(e.target.value, currentRole);
          });
        }
        document.querySelectorAll('#roleFilters button').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('#roleFilters button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentRole = this.getAttribute('data-role');
            loadChampions(searchInput.value, currentRole);
          });
        });
        document.querySelector('#roleFilters button[data-role="all"]').classList.add('active');

        document.getElementById("changeDir").addEventListener("click", async () => {
          const dir = await window.skinsAPI.changeDownloadDir();
          if (dir) alert("Directorio cambiado a: " + dir);
        });

        document.getElementById("settingsBtn").addEventListener("click", () => {
          const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
          document.getElementById("githubToken").value = localStorage.getItem("github_token") || "";
          modal.show();
        });

        document.getElementById("saveTokenBtn").addEventListener("click", () => {
          const token = document.getElementById("githubToken").value.trim();
          localStorage.setItem("github_token", token);
          window.skinsAPI.setToken(token);
          alert("Token guardado correctamente.");
          bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
        });
      }

      // --- Inicialización principal ---
      document.addEventListener("DOMContentLoaded", () => {
        const savedToken = localStorage.getItem("github_token");
        if (savedToken) window.skinsAPI.setToken(savedToken);
        initEvents();
        loadChampions();
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>